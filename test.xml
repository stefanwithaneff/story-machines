<Stateful>
  <InitState>
    <Value key="barnacleName">"Chad"</Value>
    <Value key="spongebob_mood">"happy"</Value>

  </InitState>
  <EffectHandler type="change_mood" payloadKey="effectPayload">
    <SetState key="spongebob_mood">$ctx.effectPayload.mood</SetState>
  </EffectHandler>
  <Passage>
    <Effect type="change_mood">
      <Value key="mood">"sad"</Value>
    </Effect>
    <PassageMetadata>
      <Value key="test">3</Value>
      <Object key="obj">
        <Value key="a">$state.spongebob_mood</Value>
      </Object>
      <List key="apples">
        <Value>"granny smith"</Value>
        <Value>15</Value>
        <Object>
          <Value key="hello">true</Value>
        </Object>
      </List>
    </PassageMetadata>
    <PassageText>Once upon a time, there was an ugly barnacle named {{ $state.barnacleName }}. He was so {{ "ugly" }}...</PassageText>
    <Choices>
      <MultiChoice id="abc123">
        <Choice>
          <Condition>1 lt 3</Condition>
          <ChoiceText>...everyone{{ (1 gt 3) ? " fucking " : " " }}died.</ChoiceText>
        </Choice>
        <Choice>
          <ChoiceText>...that no one ever loved him.</ChoiceText>
        </Choice>
        <Text>"That didn't help at all", Spongebob said with tears welling in his eyes.</Text>
      </MultiChoice>
      <Choice>
        <ChoiceMetadata>
          <Value key="character">"Passpartout"</Value>
        </ChoiceMetadata>
        <ChoiceText>...that he decided to be beautiful of spirit instead, and everyone loved him.</ChoiceText>
        <Selector>
          <Sequence>
            <Condition>$state.spongebob_mood eq "happy"</Condition>
            <Text>"Thanks Patrick, I feel a little better", Spongebob said, the world feeling a bit lighter.</Text>
          </Sequence>
          <Sequence>
            <Condition>$state.spongebob_mood eq "sad"</Condition>
            <Text>"Yeah, right. Like that would ever happen", Spongebob said, doubling down on his forlorn feelings.</Text>
          </Sequence>
        </Selector>
      </Choice>
      <Choice>
        <Condition>false</Condition>
        <ChoiceText>I should not appear!</ChoiceText>
        <Text>Whatever...</Text>
      </Choice>
    </Choices>
  </Passage>
  <Text>Spongebob and Patrick continued to watch the movie in silence.</Text>
  <Ink>
    <InkSyncState key="year">"1984"</InkSyncState>
    <InkSyncState key="fogg_mood">$state.spongebob_mood</InkSyncState>
    <InkStory>
      VAR fogg_mood = "calm"
      VAR year = 1888
      LONDON, {year}
      Residence of Monsieur Phileas Fogg.
      -> london

      === london ===
      Monsieur Phileas Fogg returned home early from the Reform Club, and in a new-fangled steam-carriage, besides!  
      "Passepartout," said he. "We are going around the world!"

      + "Around the world, Monsieur?"
          I was utterly astonished. 
          -> astonished
      + [Nod curtly.] -> nod


      === astonished ===
      "You are in jest!" I told him in dignified affront. "You make mock of me, Monsieur."
      "I am quite serious." # @effect change_mood mood:"quite serious"

      + "But of course"
          -> ending


      === nod ===
      I nodded curtly, not believing a word of it. # @effect change_mood mood:"foolish"
      -> ending


      === ending
      "We shall circumnavigate the globe within eighty days." He was quite {fogg_mood} as he proposed this wild scheme. "We leave for Paris on the 8:25. In an hour."

      -> END
    </InkStory>
  </Ink>
</Stateful>